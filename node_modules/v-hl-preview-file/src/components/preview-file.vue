<template>
  <div>
    <!-- 视频音频预览 start -->
    <el-dialog
      :title="fileName"
      :visible.sync="visible"
      top="5vh"
      width="1000px"
      @close="close">
      <audio v-if="isAudio" ref="audio" :src="url" controls>您的浏览器不支持 audio 标签。</audio>
      <video v-if="isVideo" ref="audio" :src="url" controls class="preview__video">您的浏览器不支持 video 标签。</video>
    </el-dialog>
    <!-- 视频音频预览 end -->
    <!-- 图片预览 start -->
    <viewer ref="viewer" :images="images" @inited="inited">
      <img v-for="src in images" :src="src" :key="src" class="hidden"/>
    </viewer>
    <!-- 图片预览 start -->
  </div>
</template>

<script>
export default {
  name: 'XmPreviewFile',
  data () {
    return {
      // 预览模态框显示
      visible: false,
      // 文件数据
      fileData: {},
      // 图片预览实例
      viewer: undefined,
    };
  },
  computed: {
    /**
     * 文件类型
     */
    fileType () {
      return this.fileData.fileType;
    },
    /**
     * 文件资源地址
     */
    url () {
      return this.fileData.url;
    },
    /**
     * 是否是图片
     */
    isImage () {
      return this.fileType === 1;
    },
    /**
     * 是否是音频
     */
    isAudio () {
      return this.fileType === 2;
    },
    /**
     * 是否是视频
     */
    isVideo () {
      return this.fileType === 3;
    },
    /**
     * 图片资源数组
     */
    images () {
      if (this.isImage) return Array.isArray(this.url) ? this.url.slice() : [this.url];
      return [];
    },
    fileName () {
      return this.fileData.resourceName;
    },
  },
  methods: {
    /**
     * 初始化预览
     * - resourceName 资源名称
     * - url 资源路径
     * - resourceSize 文件大小
     * - resourceSuffix 文件后缀
     * - resourceType 文件类型
     * - resourceStage 备课计划阶段
     * - resourceShare 共享
     * - fileType 资源类别
     * @param {*} data 文件数据
     */
    init (data) {
      if (!data) {
        this.$message.warning('数据异常，无法预览');
        return;
      }
      this.fileData = data;
      this.preview();
    },
    /**
     * 打开预览
     */
    preview () {
      switch (this.fileType) {
        case 0:
          window.open(this.url);
          break;
        case 1:
          break;
        case 2:
        case 3:
          this.visible = true;
          break;
        case 4:
        default:
          this.$message.warning('其他文件类型无预览功能');
          break;
      }
    },
    /**
     * 初始化后
     */
    inited (viewer) {
      const first = !!this.viewer;
      this.viewer = viewer;
      this.isImage && first && this.viewer.show();
    },
    /**
     * 关闭模态框
     */
    close () {
      this.fileData = {};
    },
  },
};
</script>

<style scoped>
.hidden {
  display: none;
}
.preview__video {
  width: 960px;
  height: 540px;
  margin: 0 auto;
  display: block;
}
</style>
