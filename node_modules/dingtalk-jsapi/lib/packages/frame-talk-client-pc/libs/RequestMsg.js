"use strict";var _cloneDeep=require("lodash.clonedeep"),_assign=require("lodash.assign"),msgIdSeq=0,msgIdSalt=Math.floor(1e3*Math.random()),genMsgId=function(){return 1e3*(1e3*msgIdSalt+Math.floor(1e3*Math.random()))+ ++msgIdSeq%1e3},TIMEOUT_MSG={code:408,reason:"timeout"},EVENTS_NAME={TIMEOUT:"_timeout",FINISH:"_finish"},defaultOption={timeout:-1},RequestMsg=function(e,t,i,s){this.id=genMsgId(),this.methodName=t,this.containerId=e,this.option=_assign({},defaultOption,s);var i=i||{};this._p={},this.result=new Promise(function(e,t){this._p._resolve=e,this._p._reject=t}.bind(this)),this.callbacks={},this.plainMsg=this._handleMsg(i),this._eventsHandle={},this._timeoutTimer=null,this._initTimeout(),this.isFinish=!1};RequestMsg.prototype._initTimeout=function(){this._clearTimeout(),this.option.timeout>0&&(this._timeoutTimer=setTimeout(function(){this.receiveEvent(EVENTS_NAME.TIMEOUT),this.receiveResponse(TIMEOUT_MSG,!0)}.bind(this),this.option.timeout))},RequestMsg.prototype._clearTimeout=function(){clearTimeout(this._timeoutTimer)},RequestMsg.prototype._handleMsg=function(e){var t={};return Object.keys(e).forEach(function(i){var s=e[i];"function"==typeof s&&"on"===i.slice(0,2)?this.callbacks[i]=s:t[i]=_cloneDeep(s)}.bind(this)),t},RequestMsg.prototype.getPayload=function(){return{msgId:this.id,containerId:this.containerId,methodName:this.methodName,body:this.plainMsg,type:"request"}},RequestMsg.prototype.receiveEvent=function(e,t){if(this.isFinish&&e!==EVENTS_NAME.FINISH)return!1;e!==EVENTS_NAME.FINISH&&e!==EVENTS_NAME.TIMEOUT&&this._initTimeout(),Array.isArray(this._eventsHandle[e])&&this._eventsHandle[e].forEach(function(e){try{e(t)}catch(e){console.error(t)}});var i="on"+e.charAt(0).toUpperCase()+e.slice(1);return this.callbacks[i]&&this.callbacks[i](t),!0},RequestMsg.prototype.addEventListener=function(e,t){if(!e||"function"!=typeof t)throw"eventName is null or handle is not a function, addEventListener fail";Array.isArray(this._eventsHandle[e])||(this._eventsHandle[e]=[]),this._eventsHandle[e].push(t)},RequestMsg.prototype.removeEventListener=function(e,t){if(!e||!t)throw"eventName is null or handle is null, invoke removeEventListener fail";if(Array.isArray(this._eventsHandle[e])){var i=this._eventsHandle[e].indexOf(t);-1!==i&&this._eventsHandle[e].splice(i,1)}},RequestMsg.prototype.receiveResponse=function(e,t){if(!0===this.isFinish)return!1;this._clearTimeout();var t=!!t;return t?this._p._reject(e):this._p._resolve(e),setTimeout(function(){this.receiveEvent(EVENTS_NAME.FINISH)}.bind(this),0),this.isFinish=!0,!0},module.exports=RequestMsg;